<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link rel="stylesheet" href="assets/stylesheets/estilo.css">
	<link rel="stylesheet" href="assets/stylesheets/bootstrap.min.css">
</head>
<body>
	<center>
		<h3>M3DU Downloader</h3>
	</center>
	<table style="width:100%">
		<tr>
			<td>
				<label>M3U8 URL:<label>
			</td>
			<td>
				<input type="text" id="url" class="form-control">
			</td>
		</tr>
		<tr>
			<td>
				<label>Numero</label>
			</td>
			<td>
				<input type="text" id="numero" class="form-control">
			</td>
		</tr>
	</table>
	
	<button id="convertir" class="btn btn-success">Convertir</button>
	<div>
		<pre id="result"></pre>
	</div>
	<script type="text/javascript" src="assets/javascripts/jquery-2.1.4.min.js"></script>
	<script type="text/javascript">
		var path = require("path");
		var exec = require('child-process-promise').exec;
		var ffmpeg = require('fluent-ffmpeg');
		var command = ffmpeg();
		
		$(function(){
			$("#convertir").on("click", function()
			{
				//var binario = path.join(process.cwd(),"/external_bin/ffmpeg.exe");
				var URL 	= $("#url").val();
				var Numero 	= $("#numero").val();
				var USERPROFILE = getUserHome();
				//var Comando = 'ffmpeg -i '+URL+' -c copy -bsf:a aac_adtstoasc '+USERPROFILE+'\\Videos\\video'+Numero+'.mp4';
				
				$("#result").html('Inicio de descarga: ');

				var command = ffmpeg(URL)
					.videoCodec('libx264')
  					.audioCodec('libmp3lame')
					.format('mp4')
					.on('start', function(commandLine) {
						console.log('Spawned Ffmpeg with command: ' + commandLine);
						$("#result").html('Spawned Ffmpeg with command: ' + commandLine);
					})
					.on('progress', function(progress) {
						console.log('Processing: ' + progress.percent + '% done');
						$("#result").append("<div id='progress'></div>");
						$("#progress").html('Processing: ' + parseInt(progress.percent) + '% done');
					})
					.on('error', function(err) {
						$("#result").append('An error occurred: ' + err.message);
						console.log('An error occurred: ' + err.message);
					})
					.on('end', function() {
						$("#result").append('<br />Processing finished !');
						console.log('Processing finished !');
					});
				command.save('video'+Numero+'.mp4');
				//var Comando = 'av.bat '+URL+' '+Numero;
				/*exec(Comando)
					.then(function (result) {
					    var stdout = result.stdout;
					    var stderr = result.stderr;
					    console.log('stdout: ', stdout);
						console.log('stderr: ', stderr);
						$("#result").html(stdout);
					})
					.fail(function (err) {
					    console.error('ERROR: ', err);
					    $("#result").html(err);
					})
					.progress(function (childProcess) {
					    console.log('childProcess.pid: ', childProcess.pid);
					    $("#result").html("Iniciando proceso...");
					});*/

			/*var spawn = require('child-process-promise').spawn;

			spawn('ffmpeg', ['-i',Comando])
			    .progress(function (childProcess) {
			        console.log('[spawn] childProcess.pid: ', childProcess.pid);
			        childProcess.stdout.on('data', function (data) {
			            console.log('[spawn] stdout: ', data.toString());
			        });
			        childProcess.stderr.on('data', function (data) {
			            console.log('[spawn] stderr: ', data.toString());
			        });
			    })
			    .then(function () {
			        console.log('[spawn] done!');
			    })
			    .fail(function (err) {
			        console.error('[spawn] ERROR: ', err);
			    });*/

			});
		});

		function getUserHome() {
			return process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
		}
	</script>
</body>
</html>